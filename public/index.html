<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>goChat
    </title>
    <style>
      /* Basic styling for clarity */
      #messages {
        background: #f9f9f9;
        border-radius: 8px;
        padding: 10px;
        font-size: 14px;
        line-height: 1.4;
      }
      input,
      button {
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
      }
      button:hover {
        background-color: #0056b3;
      }
    </style>
  </head>
  <body>
    <h2>WebSocket Chat</h2>
    <div id="messages"></div>
    <input id="username" type="text" placeholder="Username" />
    <input id="message" type="text" placeholder="Message" />
    <button id="sendButton">Send</button>

    <script>
      // Function to handle login and retrieve the JWT token
      function HandleLogin() {
        fetch("http://localhost:8080/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            username: "adminuser", // Replace with actual username
            password: "adminpassword", // Replace with actual password
          }),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Login failed!");
            }
            return response.json();
          })
          .then((data) => {
            console.log("JWT Token:", data.accessToken);
            console.log("Server Response Data:");
            // Store the token for future use
            localStorage.setItem("jwtToken", data.accessToken);
            connectWebSocket(data.accessToken); // Connect WebSocket after login
          })
          .catch((error) => console.error("Login Error:", error));

        console.log("Login function triggered");
      }

      // Function to establish WebSocket connection with JWT token
      function connectWebSocket(token) {
        const socket = new WebSocket(`ws://localhost:8080/ws?token=${token}`);

        socket.onopen = () => {
          console.log("Connected to WebSocket server");
        };

        socket.onmessage = (event) => {
          const msg = JSON.parse(event.data);
          const messagesDiv = document.getElementById("messages");
          const messageEl = document.createElement("div");
          messageEl.textContent = `User ${msg.sender_id}: ${msg.content} (${msg.timestamp})`;
          messagesDiv.appendChild(messageEl);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        };

        socket.onerror = (error) => {
          console.error("WebSocket Error:", error);
        };

        socket.onclose = () => {
          console.warn("WebSocket connection closed. Please log in again.");
          alert("Session expired. Please log in again.");
          HandleLogin();
        };

        // Sending messages
        document
          .getElementById("sendButton")
          .addEventListener("click", () => sendMessage(socket));
      }

      // Function to send messages through WebSocket
      function sendMessage(socket) {
        const sender_id = 1; // Replace with the actual SenderID (e.g., fetched from server-side claims)
        const message = document.getElementById("message").value;
        const payload = {
          sender_id,
          content: message,
          timestamp: new Date().toISOString(), // Use ISO format for better compatibility
        };

        if (socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify(payload));
        } else {
          console.error(
            "WebSocket is not open. Ready state:",
            socket.readyState
          );
        }

        // Clear the input field
        document.getElementById("message").value = "";
      }

      // Trigger login when the page loads
      document.addEventListener("DOMContentLoaded", () => {
        console.log("DOMContentLoaded event fired");
        HandleLogin();
      });
    </script>
  </body>
</html>
